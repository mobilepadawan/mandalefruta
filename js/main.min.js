import{mostrarMensaje,crearCategoria,crearCardHTML,crearCardErrorHTML,obtenerEndpoint}from"./utils.min.js";import{ShoppingCart}from"./class.shoppingcart.min.js";const productos=[],categorias=[],URLproductos=obtenerEndpoint()||"",categoriasContainer=document.querySelector("#categoriasContainer"),cardContainer=document.querySelector("div.card-container"),inputSearch=document.querySelector("input#inputSearch"),buttonCarrito=document.querySelector("div.shoping-cart"),divArrow=document.querySelector("div#arrow-up");function generarCategoriasUnicas(){const r=productos.map((r=>r.categoria));return[...new Set(r)]}function cargarCategorias(){categorias.push(...generarCategoriasUnicas());for(let r of categorias){let t=crearCategoria(r);categoriasContainer.appendChild(t)}}function activarFiltrosPorCategoria(){document.querySelectorAll("span#categoriaId").forEach((r=>{r.addEventListener("click",(()=>{if("Todos"===r.textContent)cargarProductos(productos);else{cargarProductos(productos.filter((t=>t.categoria===r.textContent)))}activarEventosClickBtnComprar()}))}))}function activarEventosClickBtnComprar(){document.querySelectorAll("button#buttonComprar").forEach((r=>{r.addEventListener("click",(()=>{const t=productos.find((t=>t.id===r.dataset.codigo));ShoppingCart.cartList.push(t),ShoppingCart.saveShoppingCart();const o=document.querySelector(`div [data-image="${r.dataset.codigo}"]`);o.classList.add("girar-trompo"),o.addEventListener("animationend",(()=>o.classList.remove("girar-trompo")));let e=`${t.nombre} agregado al carrito`;mostrarMensaje(e,"success")}))}))}function cargarProductos(r){r.length>0&&(cardContainer.innerHTML="",r.forEach((r=>cardContainer.innerHTML+=crearCardHTML(r))))}function agruparPorCategoria(){const r=Object.groupBy(productos,(r=>r.categoria));categoriasContainer.remove(),cardContainer.innerHTML="";for(let t in r)cardContainer.innerHTML+=crearCategoriaDiv(t),r[t].forEach((r=>cardContainer.innerHTML+=crearCardHTML(r)));activarEventosClickBtnComprar()}async function obtenerProds(){try{const r=await fetch(URLproductos);if(200!==r.status)throw new Error("Error al intentar obtener productos.");const t=await r.json();productos.push(...t),cargarCategorias(),activarFiltrosPorCategoria(),cargarProductos(productos),activarEventosClickBtnComprar()}catch(r){cardContainer.innerHTML=crearCardErrorHTML()}}function obtenerProductos(){if(!URLproductos)throw mostrarMensaje("Debes configurar un endpoint válido.","error"),new Error("Se ha producido un error: "+error.message);fetch(URLproductos).then((r=>r.json())).then((r=>productos.push(...r))).then((()=>{cargarCategorias(),activarFiltrosPorCategoria(),cargarProductos(productos),activarEventosClickBtnComprar()})).catch((r=>{cardContainer.innerHTML=crearCardErrorHTML()}))}ShoppingCart.restoreShoppingCart(),obtenerProds(),inputSearch.addEventListener("keypress",(r=>{if("Enter"===r.key&&""!==inputSearch.value.trim()&&inputSearch.value.length>=3){let r=inputSearch.value.trim().toLowerCase();const t=productos.filter((t=>t.nombre.toLowerCase().includes(r)));t.length>0?(cargarProductos(t),activarEventosClickBtnComprar()):mostrarMensaje("No se encontraron coincidencias.","alert")}})),buttonCarrito.addEventListener("mousemove",(()=>{buttonCarrito.title=0===ShoppingCart.cartList.length?"Agrega productos al carrito":ShoppingCart.cartList.length+" producto(s) en carrito"})),buttonCarrito.addEventListener("click",(r=>{ShoppingCart.cartList.length>0?location.href="checkout.html":alert("⚠️ Agrega productos al carrito.")})),window.addEventListener("offline",(()=>{mostrarMensaje("Has perdido conexión a Internet.","error")})),window.addEventListener("online",(()=>{mostrarMensaje("Ha vuelto la conectividad a Internet.","info")})),divArrow.addEventListener("click",(()=>{window.scrollTo({top:0,behavior:"smooth"})})),document.addEventListener("scroll",(()=>{window.scrollY>300?divArrow.classList.remove("hide-arrow"):divArrow.classList.add("hide-arrow")}));